# sshfs-test-final.yaml
apiVersion: v1
kind: Pod
metadata:
  name: test-frontend
  namespace: swlabpods
spec:
  containers:
  - name: frontend
    image: ubuntu:22.04
    command: ["/bin/bash", "-c"]
    args:
    - |
      # 패키지 설치 및 디렉토리 설정
      apt-get update && apt-get install -y openssh-server iputils-ping
      mkdir -p /run/sshd

      # SSHD 설정 수정 (PAM 비활성화, SFTP 경로 수정, Root 로그인 허용)
      sed -i 's/UsePAM yes/UsePAM no/g' /etc/ssh/sshd_config
      sed -i '/Subsystem/d' /etc/ssh/sshd_config
      echo "Subsystem sftp /usr/lib/openssh/sftp-server" >> /etc/ssh/sshd_config
      echo "PubkeyAuthentication yes" >> /etc/ssh/sshd_config
      echo "PermitRootLogin yes" >> /etc/ssh/sshd_config

      # SSH 키 복사 및 권한 설정
      mkdir -p /root/.ssh
      cp /etc/ssh-key-source/id_rsa.pub /root/.ssh/authorized_keys
      chmod 700 /root/.ssh
      chmod 600 /root/.ssh/authorized_keys

      # 테스트 파일 생성
      echo "Hello from Frontend!" > /root/hello.txt

      # SSHD 실행
      /usr/sbin/sshd -D -e
    volumeMounts:
    - name: public-key-vol
      mountPath: /etc/ssh-key-source
      readOnly: true
    readinessProbe:
      tcpSocket:
        port: 22
      initialDelaySeconds: 5
      periodSeconds: 10
  volumes:
  - name: public-key-vol
    configMap:
      name: backend-public-key

---

apiVersion: v1
kind: Pod
metadata:
  name: test-backend
  namespace: swlabpods
spec:
  containers:
  - name: backend
    image: ubuntu:22.04
    securityContext:
      privileged: true
    command: ["/bin/bash", "-c"]
    args:
    - |
      # 패키지 설치
      apt-get update && apt-get install -y sshfs iputils-ping
      
      # SSH 키 복사 및 권한 설정
      mkdir -p /root/.ssh
      cp /etc/secret/id_rsa /root/.ssh/id_rsa
      chmod 600 /root/.ssh/id_rsa
      
      # 대기 상태 유지
      sleep infinity
    volumeMounts:
    - name: private-key-vol
      mountPath: /etc/secret
      readOnly: true
  volumes:
  - name: private-key-vol
    secret:
      secretName: backend-ssh-key
