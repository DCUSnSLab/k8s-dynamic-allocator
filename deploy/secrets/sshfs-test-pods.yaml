# [Frontend] SSH 서버 (설정 충돌 해결 버전)
apiVersion: v1
kind: Pod
metadata:
  name: test-frontend
  namespace: swlabpods
spec:
  containers:
  - name: frontend
    image: ubuntu:22.04
    command: ["/bin/bash", "-c"]
    args:
    - |
      set -x
      
      echo ">>> 1. 패키지 설치"
      apt-get update && apt-get install -y openssh-server iputils-ping
      mkdir -p /run/sshd
      
      echo ">>> 2. SSHD 설정 (강력한 수정)"
      # PAM 끄기
      sed -i 's/UsePAM yes/UsePAM no/g' /etc/ssh/sshd_config
      
      # [수정됨] 기존 Subsystem 설정이 탭(Tab)으로 되어있을 수 있으므로 'Subsystem' 단어가 포함된 줄을 통째로 삭제
      sed -i '/Subsystem/d' /etc/ssh/sshd_config
      
      # 새 설정 추가
      echo "Subsystem sftp /usr/lib/openssh/sftp-server" >> /etc/ssh/sshd_config
      echo "PubkeyAuthentication yes" >> /etc/ssh/sshd_config
      echo "PermitRootLogin yes" >> /etc/ssh/sshd_config
      
      echo ">>> 3. SSH 키 설정"
      mkdir -p /root/.ssh
      cp /etc/ssh-key-source/id_rsa.pub /root/.ssh/authorized_keys
      chmod 700 /root/.ssh
      chmod 600 /root/.ssh/authorized_keys
      
      echo ">>> 4. 테스트 파일 생성"
      echo "Hello from Frontend!" > /root/hello.txt
      
      echo ">>> 5. SSHD 실행"
      /usr/sbin/sshd -D -e || { echo "!!! SSHD START FAILED !!!"; sleep infinity; }
      
    volumeMounts:
    - name: public-key-vol
      mountPath: /etc/ssh-key-source
      readOnly: true
  volumes:
  - name: public-key-vol
    configMap:
      name: backend-public-key

---

# [Backend] SSH 클라이언트
apiVersion: v1
kind: Pod
metadata:
  name: test-backend
  namespace: swlabpods
spec:
  containers:
  - name: backend
    image: ubuntu:22.04
    securityContext:
      privileged: true
    command: ["/bin/bash", "-c"]
    args:
    - |
      apt-get update && apt-get install -y sshfs iputils-ping
      mkdir -p /root/.ssh
      cp /etc/secret/id_rsa /root/.ssh/id_rsa
      chmod 600 /root/.ssh/id_rsa
      sleep infinity
    volumeMounts:
    - name: private-key-vol
      mountPath: /etc/secret
      readOnly: true
  volumes:
  - name: private-key-vol
    secret:
      secretName: backend-ssh-key
